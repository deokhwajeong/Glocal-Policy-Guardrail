version: '3.8'
services:
  policy-guardrail:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: policy-guardrail-scheduler
    restart: unless-stopped
    environment:
      - TZ=Asia/Seoul
      - PYTHONUNBUFFERED=1
    env_file:
      - .env
    volumes:
      # Data Persistence
      - ./reports:/app/reports
      - ./config:/app/config
      # For local development (optional)
      # - ./src:/app/src
    # No tty needed as scheduler runs in background
    # ports:
    #   - "5000:5000"  #   (  )
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        healthcheck:
      test: ["CMD", "python3", "-c", "import os; exit(0 if os.path.exists('reports/scheduler_logs') else 1)"]
      interval: 1h
      timeout: 10s
      retries: 3
      start_period: 5m
  # :
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: policy-guardrail-dashboard
    restart: unless-stopped
    command: python3 web_dashboard.py
    environment:
      - TZ=Asia/Seoul
      - PYTHONUNBUFFERED=1
    env_file:
      - .env
    volumes:
      - ./reports:/app/reports
      - ./config:/app/config
    ports:
      - "5000:5000"
    depends_on:
      - policy-guardrail
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
volumes:
  reports:
  config:
